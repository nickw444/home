ness_alarm:
  host: 192.168.8.196
  port: 8234
  zones:
    - name: Garage x2
      id: 1
    - name: Storeroom
      id: 2
    - name: Kitchen
      id: 3
    - name: Front Entrance
      id: 4
    - name: Quiet Room
      id: 5
    - name: Toy Room
      id: 6
    - name: Joes Bedroom
      id: 7
    - name: Master Bedroom
      id: 8
    - name: Upstairs Hall
      id: 9

input_boolean:
  alarm_auto_arm_override:
    name: Auto Arm
    icon: mdi:alarm-light
  alarm_auto_arm_schedule:
    name: Auto Arm Schedule
    icon: mdi:alarm-light

automation:
  - id: "1601034697138"
    alias: "alarm: send notification when triggered"
    description: ""
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_panel
        to: triggered
    condition: []
    action:
      - service: notify.admins
        data:
          title: 313A Alarm Triggered
          message: The alarm was triggered at {{ now().strftime('%I:%M %p') }}{% if states('sensor.recently_triggered_sensors') %} by {{ states('sensor.recently_triggered_sensors') }}{% endif %}
          data:
            group: alarm-status
            url: "/lovelace/security"
            entity_id: camera.nvr_garage_lowres
            actions:
              - action: "DISARM_ALARM"
                title: "Disarm"
                authenticationRequired: true
                destructive: true
            push:
              sound:
                name: default
                critical: 1
                volume: 0
    mode: single

  - id: "1601035010803"
    alias: "alarm: send notification on disarm"
    description: ""
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_panel
        to: disarmed
    action:
      - service: notify.admins
        data:
          title: 313A Alarm Disarmed
          message: The alarm was disarmed at {{ now().strftime('%I:%M %p') }}
          data:
            group: alarm-status
            tag: alarm-status
    mode: single

  - id: "1601035010807"
    alias: "alarm: send notification on disarm if triggered or pending"
    description: ""
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_panel
        to: disarmed
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: alarm_control_panel.alarm_panel
            state: pending
          - condition: state
            entity_id: alarm_control_panel.alarm_panel
            state: triggered
    action:
      - service: notify.admins
        data:
          title: 313A Alarm Disarmed
          message: The alarm was disarmed at {{ now().strftime('%I:%M %p') }}
          data:
            group: alarm-status
            tag: alarm-status
    mode: single

  - id: "1601035037271"
    alias: "alarm: send notification when pending"
    description: ""
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_panel
        to: pending
    condition: []
    action:
      - service: notify.admins
        data:
          title: 313A Alarm Pending
          message: The alarm was pending at {{ now().strftime('%I:%M %p') }}
          data:
            url: "/lovelace/security"
            entity_id: camera.nvr_garage_lowres
            group: alarm-status
            tag: alarm-status
            push:
              category: alarm
            actions:
              - action: "DISARM_ALARM"
                title: "Disarm"
                authenticationRequired: true
                destructive: true
    mode: single

  - id: "1601035065291"
    alias: "alarm: send notification when armed"
    description: ""
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_panel
        to:
          - armed_away
          - armed_night
    condition: []
    action:
      - service: notify.admins
        data:
          title: 313A Alarm Armed
          message: The alarm was armed at {{ now().strftime('%I:%M %p') }}
          data:
            group: alarm-status
            tag: alarm-status
            push:
              category: alarm
    mode: single

  - id: "1601036735034"
    alias: "alarm: disarm when mobile app disarm action fired"
    description: ""
    trigger:
      - platform: event
        event_type: ios.notification_action_fired
        event_data:
          actionName: DISARM_ALARM
    condition: []
    action:
      - service: alarm_control_panel.alarm_disarm
        data:
          code: !secret arming_code
        entity_id: alarm_control_panel.alarm_panel
    mode: single

  - id: "1591583687656"
    alias: "alarm: every thursday at 7:30am, turn off alarm auto arm"
    description: ""
    trigger:
      - at: 07:30
        platform: time
    condition:
      - condition: time
        weekday:
          - thu
    action:
      - data: {}
        entity_id: input_boolean.alarm_auto_arm_schedule
        service: input_boolean.turn_off
  - id: "1591583801235"
    alias: "alarm: every thursday at 12pm, turn on alarm auto arm"
    description: ""
    trigger:
      - at: "12:00"
        platform: time
    condition:
      - condition: time
        weekday:
          - thu
    action:
      - data: {}
        entity_id: input_boolean.alarm_auto_arm_schedule
        service: input_boolean.turn_on

template:
  - binary_sensor:
      - name: "Front Entrance Recent"
        state: "{{ is_state('binary_sensor.front_entrance', 'on') }}"
        delay_off: "00:02:00"

      - name: "Garage x2 Recent"
        state: "{{ is_state('binary_sensor.garage_x2', 'on') }}"
        delay_off: "00:02:00"

      - name: "Joes Bedroom Recent"
        state: "{{ is_state('binary_sensor.joes_bedroom', 'on') }}"
        delay_off: "00:02:00"

      - name: "Kitchen Recent"
        state: "{{ is_state('binary_sensor.kitchen', 'on') }}"
        delay_off: "00:02:00"

      - name: "Master Bedroom Recent"
        state: "{{ is_state('binary_sensor.master_bedroom', 'on') }}"
        delay_off: "00:02:00"

      - name: "Quiet Room Recent"
        state: "{{ is_state('binary_sensor.quiet_room', 'on') }}"
        delay_off: "00:02:00"

      - name: "Storeroom Recent"
        state: "{{ is_state('binary_sensor.storeroom', 'on') }}"
        delay_off: "00:02:00"

      - name: "Toy Room Recent"
        state: "{{ is_state('binary_sensor.toy_room', 'on') }}"
        delay_off: "00:02:00"

      - name: "Upstairs Hall Recent"
        state: "{{ is_state('binary_sensor.upstairs_hall', 'on') }}"
        delay_off: "00:02:00"
  - sensor:
      - name: "Recently Triggered Sensors"
        state: >
          {% set sensors = {
            'Front Entrance': 'binary_sensor.front_entrance_recent',
            'Garage x2': 'binary_sensor.garage_x2_recent',
            "Joe's Bedroom": 'binary_sensor.joes_bedroom_recent',
            'Kitchen': 'binary_sensor.kitchen_recent',
            'Master Bedroom': 'binary_sensor.master_bedroom_recent',
            'Quiet Room': 'binary_sensor.quiet_room_recent',
            'Storeroom': 'binary_sensor.storeroom_recent',
            'Toy Room': 'binary_sensor.toy_room_recent',
            'Upstairs Hall': 'binary_sensor.upstairs_hall_recent'
          } %}
          {% set recent = namespace(s=[]) %}
          {% for name, entity in sensors.items() %}
            {% if is_state(entity, 'on') %}
              {% set recent.s = recent.s + [name] %}
            {% endif %}
          {% endfor %}
          {{ recent.s | join(', ') if recent.s else 'None' }}
